name: EAS Production Build

on:
  push:
    branches: [main]

permissions:
  contents: write # needed to push tags/commits and create releases

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }} # set this in repo secrets

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm i -g eas-cli

      # - name: Run EAS Production Build and capture JSON (wait)
      #   id: eas_build
      #   run: |
      #     set -o pipefail
      #     # run build with JSON output and wait until complete
      #     eas build --platform android --profile production --non-interactive --json --wait > build-output.json
      #     cat build-output.json
      #     # parse artifact URL and buildNumber using jq
      #     BUILD_URL=$(jq -r '.[0].artifacts.buildUrl // empty' build-output.json)
      #     BUILD_ID=$(jq -r '.[0].id // empty' build-output.json)
      #     # If your build profile or EAS version uses different keys, adjust the jq path accordingly
      #     echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
      #     echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Mock EAS Output (TEST ONLY)
        id: eas_build
        run: |
          echo '[
            {
              "id": "test-build-id-001",
              "artifacts": { "buildUrl": "https://example.com/fake.apk" }
            }
          ]' > build-output.json

          BUILD_URL=$(jq -r '.[0].artifacts.buildUrl' build-output.json)
          BUILD_ID=$(jq -r '.[0].id' build-output.json)

          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Ensure jq (optional)
        run: jq --version || sudo apt-get update && sudo apt-get install -y jq

      - name: Bump package.json patch version (no git tag here)
        id: bump
        run: |
          # Avoid bumping when this commit is the bump commit to prevent loop
          if git log -1 --pretty=%B | grep -q "CI: version Bump"; then
            echo "Skip bump (already bumped by CI)"
            echo "new_version=$(node -p \"require('./package.json').version\")" >> $GITHUB_OUTPUT
            exit 0
          fi
          NEWVER=$(npm version patch --no-git-tag-version)
          echo "new_version=$NEWVER" >> $GITHUB_OUTPUT

      - name: Create git commit + tag for release
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add package.json package-lock.json || true
          git commit -m "CI: version Bump ${{ steps.bump.outputs.new_version }}" || echo "no changes to commit"
          TAG="v${{ steps.bump.outputs.new_version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin HEAD:main
          git push origin "$TAG"

      - name: Create metadata.json and upload as GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          name: "Build ${{ github.run_number }} - v${{ steps.bump.outputs.new_version }}"
          body: |
            Build Completed.
            Build ID: ${{ steps.eas_build.outputs.build_id }}
            Artifact URL: ${{ steps.eas_build.outputs.build_url }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
